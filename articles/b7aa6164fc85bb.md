---
title: "Dockeråˆå¿ƒè€…ãŒRailsã‚³ãƒ³ãƒ†ãƒŠã‚’Herokuã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹"
emoji: "ğŸ“˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [docker, ruby, rails, heroku]
published: true
---

# ã¯ã˜ã‚ã«

ä»Šå›ã¯å‰å›æ§‹ç¯‰ã—ãŸ Rails ã‚³ãƒ³ãƒ†ãƒŠã‚’ Heroku ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ã“ã¡ã‚‰ã®è¨˜äº‹ã®ç¶šãã«ãªã‚Šã¾ã™ã€‚
https://zenn.dev/takuty/articles/6f7afabca322d1

## å®Ÿè¡Œç’°å¢ƒ

- macOSï¼šBig Sur
- CPUï¼šIntel

## æ‰‹é †

1. Dockerfile å¤‰æ›´
2. database.yml å¤‰æ›´
3. production.rb å¤‰æ›´
4. Heroku ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
5. Heroku ã¸ãƒ‡ãƒ—ãƒ­ã‚¤

# Dockerfile å¤‰æ›´

Dockerfile ã§ RAILS_ENV ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’**production**ã«ã—ã¦ã¾ã™ã€‚
ã“ã‚Œã§ Rails ã‚’æœ¬ç•ªç’°å¢ƒã«é©ç”¨ã—ã¾ã™ã€‚

```Dockerfile:Dockerfile
FROM ruby:3.1.2

# ã“ã“ã‚’è¿½åŠ [Railsç’°å¢ƒã‚’æœ¬ç•ªç’°å¢ƒã«ã™ã‚‹]
ENV RAILS_ENV=production

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ã«PostgreSQLã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && apt-get install -y postgresql-client
RUN mkdir /myapp
WORKDIR /myapp
COPY Gemfile /myapp/Gemfile
COPY Gemfile.lock /myapp/Gemfile.lock
RUN gem update --system 3.3.20 && bundle install
COPY . /myapp

# ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«å®Ÿè¡Œã•ã›ã‚‹entrypoint.shã‚’è¿½åŠ 
COPY entrypoint.sh /usr/bin/
RUN chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["entrypoint.sh"]
EXPOSE 3000

# Rails ã‚µãƒ¼ãƒèµ·å‹•
CMD ["rails", "server", "-b", "0.0.0.0"]
```

# database.yml å¤‰æ›´

Dockerfile ã§**production**ã¨ã„ã†æœ¬ç•ªç’°å¢ƒã‚’è¿½åŠ ã—ãŸã®ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ–¹ã‚‚ production ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yml:config/database.yml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  host: db
  username: postgres
  password: password

development:
  <<: *default
  database: myapp_development

test:
  <<: *default
  database: myapp_test

# ã“ã“ã‚’è¿½åŠ [æœ¬ç•ªç’°å¢ƒDBè¨­å®š]
production:
  <<: *default
  database: myapp_production
```

# production.rb å¤‰æ›´

é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£ã®è¨­å®šã‚’ 2 ç®‡æ‰€å¤‰æ›´ã—ã¾ã™ã€‚

```ruby:config/environments/production.rb
# Do not fallback to assets pipeline if a precompiled asset is missed.
config.assets.compile = true # false
```

assets å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹•çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«è¨­å®šã§ã™ã€‚
ã“ã“ã§ã¯`true`ã«ã—ã¦ã„ã¾ã™ãŒã€å¸¸ã«å‹•çš„ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹å¿…è¦ãŒãªã„å ´åˆã¯Rails ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã™ã‚‹å‰ã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹æ–¹ãŒè‰¯ã„ã§ã™ã€‚

```ruby:config/environments/production.rb
# Disable serving static files from the `/public` folder by default since
# Apache or NGINX already handles this.
config.public_file_server.enabled = true # ENV["RAILS_SERVE_STATIC_FILES"].present?
```

public å†…ã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¾ã™ã€‚

# Heroku ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ

ã“ã“ã§ã¯**HerokuCLI**ã‚’ä½¿ç”¨ã—ã¦ Heroku ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ“ä½œã—ã¦ã„ãã¾ã™ã€‚

ãŠä½¿ã„ã®ç’°å¢ƒã« HerokuCLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¬å¼ã‚µã‚¤ãƒˆã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ãã ã•ã„ã€‚
https://devcenter.heroku.com/ja/articles/heroku-cli

## Heroku ã¸ãƒ­ã‚°ã‚¤ãƒ³

Heroku ã¸ã®æ“ä½œã‚’ã™ã‚‹ãŸã‚ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```shell
$ heroku login
# AWSç­‰ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã®å ´åˆ
$ heroku login -i
```

Heroku ã¸ã‚³ãƒ³ãƒ†ãƒŠã‚’ç™»éŒ²ã™ã‚‹ãŸã‚ã«ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

```shell
$ heroku container:login
```

## Heroku ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆã—ã¾ã™ã€‚

```shell
$ heroku create <ã‚¢ãƒ—ãƒªå>
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š

æ¬¡ã«ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
`database.yml`ã§ postgresql ã‚’æŒ‡å®šã—ãŸã®ã§ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ postgresql ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```shell
$ heroku addons:create heroku-postgresql:hobby-dev -a <ã‚¢ãƒ—ãƒªå>
```

ã€Œhobby-devã€ã§ã¯ heroku ã® postgresql ãƒ—ãƒ©ãƒ³ã®ä¸­ã§ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

# Heroku ã¸ãƒ‡ãƒ—ãƒ­ã‚¤

ã¾ãšäº‹å‰ã«èµ·å‹•ã—ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã•ã›ã¾ã™ã€‚

```shell
$ docker-compose down
```

Heroku ã¸ã‚³ãƒ³ãƒ†ãƒŠã‚’ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

```shell
$ heroku container:push web -a <ã‚¢ãƒ—ãƒªå>
```

```shell
$ heroku container:release web -a <ã‚¢ãƒ—ãƒªå>
```

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã‚‰ postgresql ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```shell
$ heroku run bundle exec rake db:migrate RAILS_ENV=production -a <ã‚¢ãƒ—ãƒªå>
```

ã“ã“ã¾ã§ã§å‹•ä½œã—ã¦ã„ã‚‹ã¯ãšãªã®ã§ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ã„ã¦ã¿ã¾ã™ã€‚

```shell
$ heroku open -a <ã‚¢ãƒ—ãƒªå>
```

# ã¾ã¨ã‚

Rails ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ³ãƒ†ãƒŠã§ Heroku ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æœªçµŒé¨“ã§ã—ãŸã®ã§è‰²ã€…ã¤ã¾ã¥ãã¾ã—ãŸã€‚
ä¸€åº¦ã§ãã¦ã—ã¾ã†ã¨é›£ã—ãã¯ãªã„ã§ã™ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆã‚‚å¤§ãã„ã®ã§è‰¯ã‘ã‚Œã°ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

# å‚è€ƒè³‡æ–™

https://programmingmemo.com/docker-rails-heroku/
https://qiita.com/fuku_tech/items/dc6b568f7f34df10cae7
